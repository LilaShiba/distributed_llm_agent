version: "3.8"

services:
  router:
    build: ./router
    image: llm-router:latest
    container_name: router
    ports:
      - "8000:5000"
    environment:
      PORT: "5000"
      HOST: "0.0.0.0"
      # Use service names for docker-compose DNS resolution
      WORKER_URLS: "http://worker1:5000,http://worker2:5000"
      LOG_LEVEL: "INFO"
      HEALTH_TIMEOUT: "2"
      REQUEST_TIMEOUT: "30"
      MAX_RETRIES: "2"
    depends_on:
      - worker1
      - worker2
    restart: unless-stopped
    networks:
      - llm_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  worker1:
    build: ./worker
    image: llm-worker:latest
    container_name: worker1
    environment:
      PORT: "5000"
      HOST: "0.0.0.0"
      MODEL_NAME: "distilgpt2"
      LOG_LEVEL: "INFO"
      DO_SAMPLE: "True"
      MAX_LENGTH: "100"
      TEMPERATURE: "0.7"
    restart: unless-stopped
    networks:
      - llm_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  worker2:
    build: ./worker
    image: llm-worker:latest
    container_name: worker2
    environment:
      PORT: "5000"
      HOST: "0.0.0.0"
      MODEL_NAME: "distilgpt2"
      LOG_LEVEL: "INFO"
      DO_SAMPLE: "True"
      MAX_LENGTH: "100"
      TEMPERATURE: "0.7"
    restart: unless-stopped
    networks:
      - llm_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  llm_network:
    driver: bridge
