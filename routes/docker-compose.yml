version: "3.8"

services:
  router:
    build: ../router
    image: llm-router:latest
    container_name: router
    ports:
      - "8000:5000"
    environment:
      PORT: "5000"
      HOST: "0.0.0.0"
      WORKER_URLS: "http://worker1:5000,http://worker2:5000"
      LOG_LEVEL: "INFO"
    depends_on:
      - worker1
      - worker2
    restart: unless-stopped
    networks:
      - llm_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  worker1:
    build: ../worker
    image: llm-worker:latest
    container_name: worker1
    environment:
      PORT: "5000"
      HOST: "0.0.0.0"
      MODEL_NAME: "distilgpt2"
      LOG_LEVEL: "INFO"
      DPR_QUESTION_ENCODER: "facebook/dpr-question_encoder-single-nq-base"
      DPR_CONTEXT_ENCODER: "facebook/dpr-ctx_encoder-single-nq-base"
      PDF_DIR: "pdf_corpus"
      DATA_DIR: "data"
      ENCODE_BATCH: "32"
    restart: unless-stopped
    networks:
      - llm_network
    volumes:
      - ../pdf_corpus:/app/pdf_corpus
      - ../data:/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  worker2:
    build: ../worker
    image: llm-worker:latest
    container_name: worker2
    environment:
      PORT: "5000"
      HOST: "0.0.0.0"
      MODEL_NAME: "distilgpt2"
      LOG_LEVEL: "INFO"
      DPR_QUESTION_ENCODER: "facebook/dpr-question_encoder-single-nq-base"
      DPR_CONTEXT_ENCODER: "facebook/dpr-ctx_encoder-single-nq-base"
      PDF_DIR: "pdf_corpus"
      DATA_DIR: "data"
      ENCODE_BATCH: "32"
    restart: unless-stopped
    networks:
      - llm_network
    volumes:
      - ../pdf_corpus:/app/pdf_corpus
      - ../data:/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  llm_network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 10.10.1.0/24
